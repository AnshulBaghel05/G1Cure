import{r as e,j as a}from"./ui-77ih3y5-.js";import{u as t}from"./useQuery-Dlp3A4Ud.js";import{x as s,y as i,j as n,k as l,l as r,z as d,X as c,m as o,I as m,E as x,f as u,G as p,D as h,g,d as j,e as y}from"./index-Dujr78kO.js";import{u as v}from"./useMutation-DHGRmv7m.js";import{L as f}from"./label-l12jvvxt.js";import{S as N,a as b,b as w,c as k,d as D}from"./select-DGXQeRqO.js";import{b as F}from"./client-B8Nu1JAV.js";import{m as S}from"./animations-B6zYn4RS.js";import{R as I}from"./receipt-Cjp-fwEI.js";import{D as A}from"./dollar-sign-B5-PpJzV.js";import{S as C}from"./square-pen-DnvHHSTd.js";import{T as q}from"./trash-2-CfuxWZSG.js";import"./vendor-DZByZrCh.js";import"./charts-BdQpHC93.js";import"./chevron-down-CaI_Em0f.js";import"./check-QCXJeeDZ.js";function P({bill:t,appointments:x,patients:u,onClose:p,onSuccess:h}){var g,j;const{t:y}=s(),{toast:S}=i(),I=!!t,[A,C]=e.useState({appointmentId:(null==t?void 0:t.appointmentId)||"",patientId:(null==t?void 0:t.patientId)||"",amount:(null==(g=null==t?void 0:t.amount)?void 0:g.toString())||"",taxAmount:(null==(j=null==t?void 0:t.taxAmount)?void 0:j.toString())||"0",dueDate:(null==t?void 0:t.dueDate)?new Date(t.dueDate).toISOString().split("T")[0]:"",status:(null==t?void 0:t.status)||"pending",paymentMethod:(null==t?void 0:t.paymentMethod)||"",paymentReference:(null==t?void 0:t.paymentReference)||""}),q=v({mutationFn:async e=>await F.clinic.createBill(e),onSuccess:()=>{h()},onError:e=>{S({title:y("common.error"),description:"Failed to create bill",variant:"destructive"})}}),P=v({mutationFn:async e=>await F.clinic.updateBill(e),onSuccess:()=>{h()},onError:e=>{S({title:y("common.error"),description:"Failed to update bill",variant:"destructive"})}}),B=(e,a)=>{if(C(t=>({...t,[e]:a})),"appointmentId"===e){const e=x.find(e=>e.id===a);e&&C(t=>({...t,appointmentId:a,patientId:e.patientId}))}},M=q.isPending||P.isPending,R=e=>{const a=u.find(a=>a.id===e);return a?`${a.firstName} ${a.lastName}`:"Unknown Patient"},z=(parseFloat(A.amount)||0)+(parseFloat(A.taxAmount)||0);return a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",onClick:e=>e.target===e.currentTarget&&p(),children:a.jsx("div",{className:"w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:a.jsxs(n,{children:[a.jsxs(l,{className:"flex flex-row items-center justify-between space-y-0 pb-4",children:[a.jsx(r,{className:"text-xl",children:I?"Edit Bill":y("billing.add")}),a.jsx(d,{variant:"ghost",size:"sm",onClick:p,children:a.jsx(c,{className:"w-4 h-4"})})]}),a.jsx(o,{children:a.jsxs("form",{onSubmit:async e=>{e.preventDefault();const a={...A,amount:parseFloat(A.amount),taxAmount:parseFloat(A.taxAmount),dueDate:new Date(A.dueDate)};I&&t?P.mutate({id:t.id,...a,paidAt:"paid"===A.status&&"paid"!==t.status?new Date:void 0}):q.mutate(a)},className:"space-y-6",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"appointmentId",children:"Appointment"}),a.jsxs(N,{value:A.appointmentId,onValueChange:e=>B("appointmentId",e),children:[a.jsx(b,{children:a.jsx(w,{placeholder:"Select appointment"})}),a.jsx(k,{children:x.map(e=>a.jsxs(D,{value:e.id,children:[new Date(e.appointmentDate).toLocaleDateString()," - ",R(e.patientId)]},e.id))})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"patientId",children:"Patient"}),a.jsxs(N,{value:A.patientId,onValueChange:e=>B("patientId",e),children:[a.jsx(b,{children:a.jsx(w,{placeholder:"Select patient"})}),a.jsx(k,{children:u.map(e=>a.jsxs(D,{value:e.id,children:[e.firstName," ",e.lastName]},e.id))})]})]})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"amount",children:y("billing.amount")}),a.jsx(m,{id:"amount",type:"number",min:"0",step:"0.01",value:A.amount,onChange:e=>B("amount",e.target.value),required:!0})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"taxAmount",children:y("billing.taxAmount")}),a.jsx(m,{id:"taxAmount",type:"number",min:"0",step:"0.01",value:A.taxAmount,onChange:e=>B("taxAmount",e.target.value)})]})]}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"dueDate",children:y("billing.dueDate")}),a.jsx(m,{id:"dueDate",type:"date",value:A.dueDate,onChange:e=>B("dueDate",e.target.value),required:!0})]}),I&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"status",children:y("common.status")}),a.jsxs(N,{value:A.status,onValueChange:e=>B("status",e),children:[a.jsx(b,{children:a.jsx(w,{})}),a.jsxs(k,{children:[a.jsx(D,{value:"pending",children:"Pending"}),a.jsx(D,{value:"paid",children:"Paid"}),a.jsx(D,{value:"failed",children:"Failed"}),a.jsx(D,{value:"refunded",children:"Refunded"})]})]})]})]}),I&&a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"paymentMethod",children:y("billing.paymentMethod")}),a.jsx(m,{id:"paymentMethod",value:A.paymentMethod,onChange:e=>B("paymentMethod",e.target.value),placeholder:"e.g., Credit Card, Cash, UPI"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"paymentReference",children:y("billing.paymentReference")}),a.jsx(m,{id:"paymentReference",value:A.paymentReference,onChange:e=>B("paymentReference",e.target.value),placeholder:"Transaction ID or reference"})]})]}),a.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:a.jsxs("div",{className:"flex justify-between items-center text-lg font-semibold",children:[a.jsxs("span",{children:[y("billing.totalAmount"),":"]}),a.jsxs("span",{children:["₹",z.toFixed(2)]})]})}),a.jsxs("div",{className:"flex gap-3 pt-4",children:[a.jsx(d,{type:"submit",disabled:M,className:"flex-1",children:y(M?"common.loading":"common.save")}),a.jsx(d,{type:"button",variant:"outline",onClick:p,disabled:M,children:y("common.cancel")})]})]})})]})})})}function B(){const{t:c}=s(),{toast:f}=i(),N=x(),{user:b}=u(),[w,k]=e.useState(""),[D,B]=e.useState(!1),[M,R]=e.useState(null),z="patient"===(null==b?void 0:b.role),{data:T,isLoading:$,error:E}=t({queryKey:["bills",w,null==b?void 0:b.id],queryFn:async()=>{const e={limit:100};return z&&(e.patientId=b.profile_id),await F.clinic.listBills(e)},enabled:!!b}),{data:K}=t({queryKey:["appointments"],queryFn:async()=>await F.clinic.listAppointments({limit:1e3}),enabled:!z}),{data:L}=t({queryKey:["patients"],queryFn:async()=>await F.clinic.listPatients({limit:1e3}),enabled:!z}),V=v({mutationFn:async e=>{await F.clinic.deleteBill({id:e})},onSuccess:()=>{N.invalidateQueries({queryKey:["bills"]}),f({title:c("common.success"),description:"Bill deleted successfully"})},onError:e=>{f({title:c("common.error"),description:"Failed to delete bill",variant:"destructive"})}}),Q=()=>{B(!1),R(null)},U=e=>{if(z)return`${null==b?void 0:b.first_name} ${null==b?void 0:b.last_name}`;const a=null==L?void 0:L.patients.find(a=>a.id===e);return a?`${a.firstName} ${a.lastName}`:"Unknown Patient"},_=e=>{switch(e){case"pending":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300";case"paid":return"bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300";case"failed":return"bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300";default:return"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}};return E?a.jsx("div",{className:"text-center py-12",children:a.jsxs("p",{className:"text-red-600",children:[c("common.error"),": ",E.message]})}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:c("billing.title")}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:z?"View your invoices and payment history":"Manage invoices and payment records"})]})}),a.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"flex items-center gap-4",children:a.jsxs("div",{className:"relative flex-1 max-w-md",children:[a.jsx(p,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),a.jsx(m,{placeholder:z?"Search by invoice number or date...":c("common.search"),value:w,onChange:e=>k(e.target.value),className:"pl-10"})]})}),$?a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[...Array(6)].map((e,t)=>a.jsxs(n,{className:"animate-pulse bg-white dark:bg-gray-800",children:[a.jsxs(l,{children:[a.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),a.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"})]}),a.jsx(o,{children:a.jsxs("div",{className:"space-y-2",children:[a.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded"}),a.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded w-2/3"})]})})]},t))}):a.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:null==T?void 0:T.bills.map((e,t)=>a.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*t},whileHover:{y:-2},children:a.jsxs(n,{className:"h-full transition-all duration-200 hover:shadow-lg dark:bg-gray-800",children:[a.jsx(l,{className:"pb-3",children:a.jsxs("div",{className:"flex items-start justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 bg-green-100 dark:bg-green-900/50 rounded-full flex items-center justify-center",children:a.jsx(I,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),a.jsxs("div",{children:[a.jsx(r,{className:"text-lg dark:text-white",children:e.invoiceNumber}),a.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:new Date(e.createdAt).toLocaleDateString()})]})]}),a.jsx(h,{className:_(e.status),children:e.status})]})}),a.jsxs(o,{className:"space-y-3",children:[a.jsxs("div",{className:"space-y-2 text-sm",children:[!z&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(g,{className:"w-4 h-4 text-gray-400"}),a.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Patient:"}),a.jsx("span",{className:"font-medium dark:text-white",children:U(e.patientId)})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Amount:"}),a.jsxs("span",{className:"font-medium dark:text-white",children:["₹",e.amount.toFixed(2)]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Tax:"}),a.jsxs("span",{className:"dark:text-white",children:["₹",e.taxAmount.toFixed(2)]})]}),a.jsxs("div",{className:"flex justify-between border-t pt-2 dark:border-gray-700",children:[a.jsx("span",{className:"text-gray-600 dark:text-gray-300 font-medium",children:"Total:"}),a.jsxs("span",{className:"font-bold text-lg dark:text-white",children:["₹",e.totalAmount.toFixed(2)]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(j,{className:"w-4 h-4 text-gray-400"}),a.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Due:"}),a.jsx("span",{className:new Date(e.dueDate)<new Date&&"pending"===e.status?"text-red-600 dark:text-red-400 font-medium":"dark:text-white",children:new Date(e.dueDate).toLocaleDateString()})]})]}),a.jsxs("div",{className:"flex gap-2 pt-2",children:[z&&"pending"===e.status&&a.jsxs(d,{size:"sm",className:"flex-1",children:[a.jsx(A,{className:"w-3 h-3 mr-1"}),"Pay Now"]}),!z&&a.jsxs(a.Fragment,{children:[a.jsxs(d,{variant:"outline",size:"sm",onClick:()=>(e=>{R(e),B(!0)})(e),className:"flex-1",children:[a.jsx(C,{className:"w-3 h-3 mr-1"}),c("common.edit")]}),a.jsx(d,{variant:"outline",size:"sm",onClick:()=>(async e=>{window.confirm("Are you sure you want to delete this bill?")&&V.mutate(e)})(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/50 dark:hover:text-red-300",children:a.jsx(q,{className:"w-3 h-3"})})]})]})]})]})},e.id))}),0===(null==T?void 0:T.bills.length)&&!$&&a.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-12",children:[a.jsx(y,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No bills found"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:z?"You have no outstanding or past bills.":"Bills will be automatically generated when appointments are created."})]}),D&&!z&&a.jsx(P,{bill:M,appointments:(null==K?void 0:K.appointments)||[],patients:(null==L?void 0:L.patients)||[],onClose:Q,onSuccess:()=>{N.invalidateQueries({queryKey:["bills"]}),Q(),f({title:c("common.success"),description:M?"Bill updated successfully":"Bill created successfully"})}})]})}export{B as BillingPage};
